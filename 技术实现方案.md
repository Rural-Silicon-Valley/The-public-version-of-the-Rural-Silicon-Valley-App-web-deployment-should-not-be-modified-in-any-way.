# 功能开发技术方案文档

## 详细实现指南

### 1. 任务优先级实现代码

#### 修改类型定义

```typescript
// src/types/index.ts
export type TaskPriority = 'high' | 'medium' | 'low' | 'defer';

export interface Task {
  id: string;
  title: string;
  description: string;
  assignedTo: string[];
  createdBy: string;
  createdAt: Date;
  dueDate: Date;
  priority: TaskPriority; // 新增字段
  priorityColor: string;   // 新增字段
  status: 'pending' | 'completed';
}
```

#### 优先级配置

```typescript
// src/utils/priority.ts
import { Star, StarBorder, StarHalf, StarOutline } from '@mui/icons-material';

export const PRIORITY_CONFIG = {
  high: { label: '紧急重要', color: '#f44336', icon: Star },
  medium: { label: '重要不紧急', color: '#ff9800', icon: StarHalf },
  low: { label: '普通任务', color: '#4caf50', icon: StarBorder },
  defer: { label: '可延期', color: '#9e9e9e', icon: StarOutline }
};

export const getPriorityConfig = (priority: TaskPriority) => PRIORITY_CONFIG[priority];
```

#### 优先级选择组件

```typescript
// src/components/PrioritySelector.tsx
import React from 'react';
import { FormControl, InputLabel, Select, MenuItem, Chip, Box } from '@mui/material';
import { TaskPriority } from '../types';
import { PRIORITY_CONFIG } from '../utils/priority';

interface PrioritySelectorProps {
  value: TaskPriority;
  onChange: (priority: TaskPriority) => void;
}

export const PrioritySelector: React.FC<PrioritySelectorProps> = ({ value, onChange }) => {
  return (
    <FormControl fullWidth>
      <InputLabel>任务优先级</InputLabel>
      <Select value={value} onChange={(e) => onChange(e.target.value as TaskPriority)}>
        {Object.entries(PRIORITY_CONFIG).map(([key, config]) => {
          const IconComponent = config.icon;
          return (
            <MenuItem key={key} value={key}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <IconComponent sx={{ color: config.color }} />
                <span>{config.label}</span>
              </Box>
            </MenuItem>
          );
        })}
      </Select>
    </FormControl>
  );
};
```

### 2. 任务状态增强实现

#### 扩展状态类型

```typescript
// src/types/index.ts
export type TaskStatus = 'pending' | 'in_progress' | 'paused' | 'completed' | 'overdue' | 'need_help';

export interface TaskStatusHistory {
  status: TaskStatus;
  timestamp: Date;
  updatedBy: string;
  comment?: string;
}

export interface Task {
  // 现有字段...
  status: TaskStatus;
  statusUpdateTime: Date;
  statusHistory: TaskStatusHistory[];
}
```

#### 状态配置和工具函数

```typescript
// src/utils/taskStatus.ts
import { 
  Schedule, 
  PlayArrow, 
  Pause, 
  CheckCircle, 
  Warning, 
  Help 
} from '@mui/icons-material';

export const TASK_STATUS_CONFIG = {
  pending: { label: '未开始', color: '#9e9e9e', icon: Schedule },
  in_progress: { label: '进行中', color: '#2196f3', icon: PlayArrow },
  paused: { label: '暂停', color: '#ff9800', icon: Pause },
  completed: { label: '已完成', color: '#4caf50', icon: '✅' },
  overdue: { label: '逾期', color: '#f44336', icon: '⚠️' },
  need_help: { label: '需要帮助', color: '#9c27b0', icon: '🆘' }
};

export const getStatusConfig = (status: TaskStatus) => TASK_STATUS_CONFIG[status];

export const isTaskOverdue = (task: Task): boolean => {
  return new Date() > new Date(task.dueDate) && task.status !== 'completed';
};
```

### 3. 评论系统实现

#### 评论数据类型

```typescript
// src/types/index.ts
export interface TaskComment {
  id: string;
  taskId: string;
  userId: string;
  userName: string;
  userAvatar: string;
  content: string;
  timestamp: Date;
  parentCommentId?: string;
  attachments?: string[];
}
```

#### 评论组件

```typescript
// src/components/TaskComments.tsx
import React, { useState } from 'react';
import { 
  Box, TextField, Button, List, ListItem, 
  Avatar, Typography, Paper, Divider 
} from '@mui/material';
import { TaskComment } from '../types';

interface TaskCommentsProps {
  taskId: string;
  comments: TaskComment[];
  onAddComment: (content: string) => void;
}

export const TaskComments: React.FC<TaskCommentsProps> = ({ 
  taskId, comments, onAddComment 
}) => {
  const [newComment, setNewComment] = useState('');

  const handleSubmit = () => {
    if (newComment.trim()) {
      onAddComment(newComment);
      setNewComment('');
    }
  };

  return (
    <Box>
      <Typography variant="h6" gutterBottom>
        评论 ({comments.length})
      </Typography>
      
      {/* 评论列表 */}
      <List>
        {comments.map((comment) => (
          <ListItem key={comment.id} alignItems="flex-start">
            <Paper sx={{ width: '100%', p: 2, mb: 1 }}>
              <Box display="flex" alignItems="center" mb={1}>
                <Avatar src={comment.userAvatar} sx={{ width: 32, height: 32, mr: 1 }}>
                  {comment.userName[0]}
                </Avatar>
                <Typography variant="subtitle2">{comment.userName}</Typography>
                <Typography variant="caption" color="text.secondary" ml="auto">
                  {new Date(comment.timestamp).toLocaleString()}
                </Typography>
              </Box>
              <Typography variant="body2">{comment.content}</Typography>
            </Paper>
          </ListItem>
        ))}
      </List>

      <Divider sx={{ my: 2 }} />

      {/* 添加评论 */}
      <Box display="flex" gap={1}>
        <TextField
          fullWidth
          multiline
          rows={2}
          placeholder="添加评论..."
          value={newComment}
          onChange={(e) => setNewComment(e.target.value)}
        />
        <Button variant="contained" onClick={handleSubmit}>
          发布
        </Button>
      </Box>
    </Box>
  );
};
```

### 4. 工作时间记录实现

#### 时间记录类型

```typescript
// src/types/index.ts
export interface TimeLog {
  id: string;
  taskId: string;
  userId: string;
  startTime: Date;
  endTime?: Date;
  duration: number; // 分钟
  pausedTime: number;
  isActive: boolean;
}

export interface WorkTimeStats {
  dailyTotal: number;
  weeklyTotal: number;
  taskAverageTime: Record<string, number>;
  efficiency: number;
}
```

#### 计时器组件

```typescript
// src/components/TaskTimer.tsx
import React, { useState, useEffect } from 'react';
import { Box, Button, Typography, Chip } from '@mui/material';
import { PlayArrow, Pause, Stop } from '@mui/icons-material';

interface TaskTimerProps {
  taskId: string;
  onTimeLog: (duration: number) => void;
}

export const TaskTimer: React.FC<TaskTimerProps> = ({ taskId, onTimeLog }) => {
  const [isRunning, setIsRunning] = useState(false);
  const [startTime, setStartTime] = useState<Date | null>(null);
  const [elapsedTime, setElapsedTime] = useState(0);

  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isRunning && startTime) {
      interval = setInterval(() => {
        setElapsedTime(Math.floor((Date.now() - startTime.getTime()) / 1000));
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isRunning, startTime]);

  const handleStart = () => {
    setStartTime(new Date());
    setIsRunning(true);
  };

  const handlePause = () => {
    setIsRunning(false);
  };

  const handleStop = () => {
    if (startTime) {
      const duration = Math.floor((Date.now() - startTime.getTime()) / 60000); // 分钟
      onTimeLog(duration);
    }
    setIsRunning(false);
    setStartTime(null);
    setElapsedTime(0);
  };

  const formatTime = (seconds: number) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <Box display="flex" alignItems="center" gap={1}>
      <Chip 
        label={formatTime(elapsedTime)}
        color={isRunning ? "primary" : "default"}
        variant={isRunning ? "filled" : "outlined"}
      />
      
      {!isRunning ? (
        <Button 
          startIcon={<PlayArrow />} 
          onClick={handleStart}
          size="small"
        >
          开始计时
        </Button>
      ) : (
        <>
          <Button 
            startIcon={<Pause />} 
            onClick={handlePause}
            size="small"
          >
            暂停
          </Button>
          <Button 
            startIcon={<Stop />} 
            onClick={handleStop}
            size="small"
            color="secondary"
          >
            完成
          </Button>
        </>
      )}
    </Box>
  );
};
```

### 5. 通知服务实现

#### 通知服务类

```typescript
// src/services/NotificationService.ts
export class NotificationService {
  private static instance: NotificationService;

  static getInstance(): NotificationService {
    if (!NotificationService.instance) {
      NotificationService.instance = new NotificationService();
    }
    return NotificationService.instance;
  }

  async requestPermission(): Promise<boolean> {
    if (!('Notification' in window)) {
      console.warn('浏览器不支持通知功能');
      return false;
    }

    if (Notification.permission === 'granted') {
      return true;
    }

    if (Notification.permission === 'denied') {
      return false;
    }

    const permission = await Notification.requestPermission();
    return permission === 'granted';
  }

  showNotification(title: string, options?: NotificationOptions): void {
    if (Notification.permission === 'granted') {
      new Notification(title, {
        icon: '/favicon.ico',
        badge: '/badge-icon.png',
        ...options
      });
    }
  }

  scheduleTaskReminder(task: Task): void {
    const now = new Date();
    const dueDate = new Date(task.dueDate);
    const reminderTime = new Date(dueDate.getTime() - 60 * 60 * 1000); // 提前1小时

    if (reminderTime > now) {
      const delay = reminderTime.getTime() - now.getTime();
      setTimeout(() => {
        this.showNotification(`任务提醒: ${task.title}`, {
          body: '任务将在1小时后到期，请及时处理',
          tag: `task-reminder-${task.id}`
        });
      }, delay);
    }
  }

  showDailyTaskSummary(tasks: Task[]): void {
    const pendingTasks = tasks.filter(t => t.status !== 'completed');
    this.showNotification('今日任务提醒', {
      body: `您有 ${pendingTasks.length} 个待完成任务`,
      tag: 'daily-summary'
    });
  }
}
```

## 集成到现有项目

### 修改 AppContext

```typescript
// src/context/AppContext.tsx
interface AppState {
  // 现有字段...
  timeLogs: TimeLog[];
  comments: TaskComment[];
  notifications: NotificationSettings;
}

interface AppContextType {
  // 现有方法...
  addTimeLog: (timeLog: TimeLog) => void;
  addComment: (comment: TaskComment) => void;
  updateTaskStatus: (taskId: string, status: TaskStatus) => void;
  updateTaskPriority: (taskId: string, priority: TaskPriority) => void;
}
```

### 修改 mockData

```typescript
// src/utils/mockData.ts
export const mockTasks: Task[] = [
  {
    id: '1',
    title: '完成项目文档',
    description: '整理项目相关文档',
    assignedTo: ['user1'],
    createdBy: 'admin1',
    createdAt: new Date('2024-01-15'),
    dueDate: new Date('2024-01-20'),
    priority: 'high', // 新增
    priorityColor: '#f44336', // 新增
    status: 'in_progress', // 修改
    statusUpdateTime: new Date(),
    statusHistory: []
  },
  // ... 其他任务
];
```

这些代码可以直接集成到您现有的项目中，按照优先级逐步实现。每个功能都是独立的，可以单独开发和测试。
